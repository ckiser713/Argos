# =============================================================================
# Cortex Caddyfile - Production Reverse Proxy Configuration
# =============================================================================
# Caddy automatically obtains and renews SSL certificates from Let's Encrypt.
#
# Features:
# - HTTPS with automatic certificate management
# - HTTP/2 and HTTP/3 support
# - WebSocket support for agent streaming
# - Proper security headers
# - Gzip compression
# - Static file serving for frontend
# =============================================================================

# Global options
{
	# Email for Let's Encrypt notifications
	email {$CORTEX_ADMIN_EMAIL:admin@localhost}
	
	# Use staging CA for testing (comment out for production)
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
	
	# Enable HTTP/3
	servers {
		protocol {
			experimental_http3
		}
	}
}

# Main site configuration
{$CORTEX_DOMAIN:localhost} {
	# Logging
	log {
		output stdout
		format json
		level INFO
	}

	# Enable compression
	encode gzip zstd

	# Security headers
	header {
		# HSTS - enable after confirming SSL works
		# Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		
		# Prevent clickjacking
		X-Frame-Options "SAMEORIGIN"
		
		# Prevent MIME type sniffing
		X-Content-Type-Options "nosniff"
		
		# XSS protection
		X-XSS-Protection "1; mode=block"
		
		# Referrer policy
		Referrer-Policy "strict-origin-when-cross-origin"
		
		# Remove server header
		-Server
	}

	# Health check endpoint (for load balancers)
	handle /health {
		respond "OK" 200
	}

	# API routes - proxy to backend
	handle /api/* {
		reverse_proxy backend:8000 {
			# Health checks
			health_uri /api/system/health
			health_interval 30s
			health_timeout 10s
			
			# Timeouts for long-running LLM requests
			transport http {
				read_timeout 300s
				write_timeout 300s
			}
			
			# Headers
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# WebSocket routes for agent streaming
	handle /api/ws/* {
		reverse_proxy backend:8000 {
			# WebSocket support
			transport http {
				read_timeout 0
				write_timeout 0
			}
			
			# Headers for WebSocket
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
			header_up Connection {>Connection}
			header_up Upgrade {>Upgrade}
		}
	}

	# n8n webhooks
	handle /webhooks/* {
		reverse_proxy n8n:5678 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# n8n UI (optional - can be removed for security)
	handle /n8n/* {
		uri strip_prefix /n8n
		reverse_proxy n8n:5678 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}
			header_up X-Forwarded-Proto {scheme}
		}
	}

	# Frontend static files
	handle {
		root * /srv/frontend
		
		# Try files, fallback to index.html for SPA routing
		try_files {path} /index.html
		
		file_server {
			# Enable directory browsing (optional, disable for security)
			# browse
		}
		
		# Cache static assets
		@static {
			path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
		}
		header @static Cache-Control "public, max-age=31536000, immutable"
		
		# Don't cache HTML
		@html {
			path *.html
		}
		header @html Cache-Control "no-cache, no-store, must-revalidate"
	}
}

# Redirect HTTP to HTTPS (automatic with Caddy, but explicit for clarity)
http://{$CORTEX_DOMAIN:localhost} {
	redir https://{host}{uri} permanent
}

# Optional: www redirect
http://www.{$CORTEX_DOMAIN:localhost}, https://www.{$CORTEX_DOMAIN:localhost} {
	redir https://{$CORTEX_DOMAIN:localhost}{uri} permanent
}
