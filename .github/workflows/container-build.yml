name: Container Builds

on:
  workflow_dispatch:
    inputs:
      run_smoke:
        description: "Run backend smoke check after build"
        required: false
        default: false
        type: boolean
      push_image:
        description: "Push images (requires registry permissions)"
        required: false
        default: false
        type: boolean
      image_tag:
        description: "Override image tag (defaults to tag name or git SHA)"
        required: false
        default: ""
        type: string
  push:
    branches: [main, master]
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: backend
            file: Dockerfile.backend
            context: .
          - name: frontend
            file: Dockerfile.frontend
            context: .
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Normalize image name
        id: names
        run: echo "image=${IMAGE_NAME,,}" >> "$GITHUB_OUTPUT"
        env:
          IMAGE_NAME: ${{ env.IMAGE_NAME }}

      - name: Compute image tag
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_SHA::12}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log in to GHCR (only when pushing)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.push_image == 'true' || startsWith(github.ref, 'refs/tags/') }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build container
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.file }}
          load: true
          push: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.push_image == 'true') || startsWith(github.ref, 'refs/tags/') }}
          tags: ${{ env.REGISTRY }}/${{ steps.names.outputs.image }}:${{ steps.meta.outputs.tag }}-${{ matrix.name }}

      - name: Backend smoke check
        if: ${{ matrix.name == 'backend' && ( (github.event_name == 'workflow_dispatch' && github.event.inputs.run_smoke == 'true') || startsWith(github.ref, 'refs/tags/') ) }}
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ steps.names.outputs.image }}:${{ steps.meta.outputs.tag }}-backend
        run: |
          docker run -d --rm --name cortex-backend-smoke \
            -e CORTEX_ENV=local \
            -e CORTEX_SKIP_AUTH=1 \
            -e CORTEX_DATABASE_URL=sqlite:////tmp/atlas.db \
            -e CORTEX_ATLAS_DB_PATH=/tmp/atlas.db \
            -p 8000:8000 \
            "$IMAGE"

          for i in {1..30}; do
            if curl -sf http://localhost:8000/api/system/health >/dev/null; then
              docker rm -f cortex-backend-smoke >/dev/null 2>&1 || true
              exit 0
            fi
            sleep 2
          done

          echo "Backend health endpoint did not respond in time" >&2
          docker logs cortex-backend-smoke || true
          docker rm -f cortex-backend-smoke >/dev/null 2>&1 || true
          exit 1

      - name: Redis + Celery smoke (optional)
        if: ${{ matrix.name == 'backend' && github.event_name == 'workflow_dispatch' && github.event.inputs.run_smoke == 'true' }}
        env:
          IMAGE: ${{ env.REGISTRY }}/${{ steps.names.outputs.image }}:${{ steps.meta.outputs.tag }}-backend
        run: |
          docker network create cortex-smoke || true
          docker run -d --rm --name cortex-redis-smoke --network cortex-smoke redis:7.2-alpine
          # Give Redis a moment
          sleep 3
          docker run --rm --network cortex-smoke \
            -e CORTEX_ENV=local \
            -e RUNNING_IN_DOCKER=1 \
            -e CORTEX_SKIP_AUTH=1 \
            -e CORTEX_DATABASE_URL=sqlite:////tmp/atlas.db \
            -e CORTEX_ATLAS_DB_PATH=/tmp/atlas.db \
            -e CORTEX_CELERY_BROKER_URL=redis://cortex-redis-smoke:6379/0 \
            -e CORTEX_CELERY_RESULT_BACKEND=redis://cortex-redis-smoke:6379/0 \
            "$IMAGE" \
            celery -A app.worker.celery_app inspect ping -d celery@$(hostname)
          docker stop cortex-redis-smoke >/dev/null 2>&1 || true

